<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel (Testing) - Islamic Community Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
    <!-- Note: For full user management (listing all users), you'd typically need the Firebase Admin SDK on a backend/Cloud Function.
         Client-side auth.listUsers() is not available. We'll simulate or fetch from a user collection if you create one. -->

    <style>
        /* ... (Keep all the CSS from the previous admin panel response) ... */
        :root {
            --primary-color: #006400; --secondary-color: #004d00; --accent-color: #FFD700;
            --light-bg: #f4f6f9; --sidebar-bg: #2c3e50; --sidebar-text: #ecf0f1;
            --sidebar-active-bg: var(--primary-color); --text-color: #333; --card-bg: #ffffff;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1); --danger-color: #dc3545;
            --success-color: #28a745; --warning-color: #ffc107;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--light-bg); color: var(--text-color); display: flex; min-height: 100vh; flex-direction: column; }
        #admin-key-access-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; background-color: var(--sidebar-bg); color: var(--sidebar-text); }
        .key-access-container { background-color: var(--card-bg); color: var(--text-color); padding: 2.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .key-access-container h1 { color: var(--primary-color); margin-bottom: 0.5rem; }
        .key-access-container p { margin-bottom: 1.5rem; font-size: 0.9rem; color: #777; }
        .key-access-form input { width: 100%; padding: 12px; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .key-access-form button { width: 100%; background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 5px; font-size: 1.1rem; cursor: pointer; transition: background-color 0.3s ease; }
        .key-access-form button:hover { background-color: var(--secondary-color); }
        #key-error-message { color: var(--danger-color); margin-top: 1rem; font-size: 0.9rem; display: none; }
        #admin-panel-screen { display: none; flex-direction: row; width: 100%; flex-grow: 1; }
        .admin-sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding-top: 1.5rem; display: flex; flex-direction: column; transition: width 0.3s ease; }
        .admin-sidebar .logo { text-align: center; margin-bottom: 2rem; padding: 0 1rem; }
        .admin-sidebar .logo h2 { font-size: 1.5rem; color: var(--accent-color); }
        .admin-sidebar .logo p { font-size: 0.8rem; opacity: 0.7; }
        .admin-sidebar nav ul { list-style: none; }
        .admin-sidebar nav ul li a { display: flex; align-items: center; padding: 1rem 1.5rem; color: var(--sidebar-text); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.95rem; }
        .admin-sidebar nav ul li a i { margin-right: 12px; width: 20px; text-align: center; }
        .admin-sidebar nav ul li a:hover, .admin-sidebar nav ul li a.active { background-color: var(--sidebar-active-bg); color: white; border-left: 3px solid var(--accent-color); padding-left: calc(1.5rem - 3px); }
        .admin-sidebar .logout-link { margin-top: auto; }
        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .admin-header { background-color: var(--card-bg); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-bottom: 1px solid #e0e0e0; }
        .admin-header h1 { font-size: 1.5rem; color: var(--primary-color); }
        .admin-info span { margin-right: 10px; font-size: 0.9rem; }
        .admin-info .fas { color: var(--primary-color); }
        .admin-content { padding: 1.5rem; flex-grow: 1; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .content-title { font-size: 1.8rem; color: var(--text-color); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-color); }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .dash-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); display: flex; align-items: center; }
        .dash-card .icon { font-size: 2.5rem; padding: 1rem; border-radius: 50%; margin-right: 1rem; color: white; }
        .dash-card .icon.users { background-color: #17a2b8; }
        .dash-card .icon.content { background-color: #28a745; }
        .dash-card .icon.activity { background-color: #ffc107; }
        .dash-card .icon.settings { background-color: #6c757d; }
        .dash-card .info h3 { font-size: 1.8rem; margin-bottom: 0.2rem; }
        .dash-card .info p { font-size: 0.9rem; color: #666; }
        .table-container { background-color: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: var(--shadow); overflow-x: auto; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .admin-table th { background-color: var(--light-bg); font-weight: 600; color: var(--primary-color); }
        .admin-table tbody tr:hover { background-color: #f1f1f1; }
        .admin-table .actions a, .admin-table .actions button { color: var(--primary-color); margin-right: 8px; text-decoration: none; background: none; border: none; cursor: pointer; font-size: 1rem; }
        .admin-table .actions a:hover, .admin-table .actions button:hover { opacity: 0.7; }
        .admin-table .actions .fa-trash-alt { color: var(--danger-color); }
        .admin-table .actions .fa-user-slash { color: var(--warning-color); }
        .admin-table .actions .fa-user-check { color: var(--success-color); }
        .status-active { color: var(--success-color); font-weight: bold; }
        .status-banned { color: var(--danger-color); font-weight: bold; }
        .status-pending { color: var(--warning-color); font-weight: bold; }
        .btn { padding: 10px 20px; border-radius: 5px; text-decoration: none; font-size: 0.9rem; cursor: pointer; border: none; transition: opacity 0.2s ease; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .table-actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .table-actions-bar input[type="search"] { padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; min-width: 250px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: .5rem; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 90%; max-width: 600px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; border-bottom: 1px solid #e9ecef; margin-bottom: 1rem; }
        .modal-header h3 { font-size: 1.5rem; color: var(--primary-color); }
        .close-modal { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover, .close-modal:focus { color: var(--text-color); text-decoration: none; }
        .modal-body form label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .modal-body form input, .modal-body form select, .modal-body form textarea { width: 100%; padding: 10px; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        .modal-footer { padding-top: 1rem; border-top: 1px solid #e9ecef; margin-top: 1rem; text-align: right; }
        .modal-footer .btn + .btn { margin-left: 0.5rem; }
        #nav-items-list li { background: #f9f9f9; padding: 10px; margin-bottom: 5px; border: 1px solid #eee; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        #nav-items-list li .actions button { margin-left: 5px; }
        .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loader { border: 8px solid var(--light-bg); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            #admin-panel-screen { flex-direction: column; }
            .admin-sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding-top: 0; align-items: center; }
            .admin-sidebar .logo { margin-bottom: 0; padding: 0.8rem 1rem;} .admin-sidebar .logo h2 { font-size: 1.2rem; }
            .admin-sidebar .logo p { display: none; } .admin-sidebar nav ul { display: flex; flex-direction: row; }
            .admin-sidebar nav ul li a { padding: 0.8rem 1rem; font-size: 0.9rem; } .admin-sidebar nav ul li a i { margin-right: 5px; }
            .admin-sidebar nav ul li a.active { border-left: none; border-bottom: 3px solid var(--accent-color); }
            .admin-sidebar .logout-link { margin-top: 0; margin-left: auto; } .main-wrapper { width: 100%; }
            .admin-header h1 { font-size: 1.2rem; } .dashboard-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loader" class="loader-container" style="display:none;"><div class="loader"></div></div>

    <!-- Admin Key Access Screen -->
    <div id="admin-key-access-screen" style="display: flex;">
        <div class="key-access-container">
            <h1><i class="fas fa-key"></i> Admin Access</h1>
            <p>Enter the access key to continue.</p>
            <form id="admin-key-form" class="key-access-form">
                <input type="password" id="admin-access-key" placeholder="Access Key" required>
                <button type="submit">Enter Panel</button>
            </form>
            <p id="key-error-message">Invalid access key.</p>
        </div>
    </div>

    <!-- Main Admin Panel (Hidden by default) -->
    <div id="admin-panel-screen">
        <aside class="admin-sidebar">
            <div class="logo">
                <h2><i class="fas fa-mosque"></i> Admin</h2>
                <p>Islamic Community Hub</p>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-target="dashboard-view"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" class="nav-link" data-target="user-management-view"><i class="fas fa-users-cog"></i> User Management</a></li>
                    <li><a href="#" class="nav-link" data-target="nav-management-view"><i class="fas fa-sitemap"></i> Nav Management</a></li>
                    <li><a href="#" class="nav-link" data-target="content-management-view"><i class="fas fa-file-alt"></i> Content (Demo)</a></li>
                    <li><a href="#" class="nav-link" data-target="settings-view"><i class="fas fa-cogs"></i> Settings (Demo)</a></li>
                    <li class="logout-link"><a href="#" id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Exit Panel</a></li>
                </ul>
            </nav>
        </aside>

        <div class="main-wrapper">
            <header class="admin-header">
                <h1 id="current-section-title">Dashboard</h1>
                <div class="admin-info">
                    <span>Welcome, <strong id="admin-name-display">Test Admin</strong>!</span>
                    <i class="fas fa-user-shield fa-lg"></i>
                </div>
            </header>

            <main class="admin-content">
                <!-- Dashboard Section -->
                <section id="dashboard-view" class="content-section active">
                    <!-- ... (Dashboard content same as before) ... -->
                     <h2 class="content-title">Overview</h2>
                    <div class="dashboard-cards">
                        <div class="dash-card">
                            <div class="icon users"><i class="fas fa-users"></i></div>
                            <div class="info"> <h3 id="total-users-count">0</h3> <p>Total Users</p> </div>
                        </div>
                        <div class="dash-card">
                            <div class="icon content"><i class="fas fa-file-signature"></i></div>
                            <div class="info"> <h3 id="total-posts-count">0</h3> <p>Content/Posts</p> </div>
                        </div>
                         <div class="dash-card">
                            <div class="icon activity"><i class="fas fa-sitemap"></i></div>
                            <div class="info"> <h3 id="total-nav-links-count">0</h3> <p>Navigation Links</p> </div>
                        </div>
                    </div>
                </section>

                <!-- User Management Section -->
                <section id="user-management-view" class="content-section">
                    <h2 class="content-title">User Management</h2>
                     <p class="info-text" style="margin-bottom:1rem; font-style:italic; color:#555;">Note: Full user listing requires Admin SDK. This section demonstrates UI with dummy data or data from a 'users' collection if available.</p>
                    <div class="table-actions-bar">
                        <input type="search" id="user-search-input" placeholder="Search users (name, email)...">
                        <!-- Add user might need more complex logic if not just using Firebase Auth -->
                    </div>
                    <div class="table-container">
                        <table class="admin-table" id="users-table">
                            <thead>
                                <tr>
                                    <th>User ID (UID)</th>
                                    <th>Display Name</th>
                                    <th>Email</th>
                                    <th>Provider</th>
                                    <th>Status</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>

                <!-- Navigation Management Section -->
                <section id="nav-management-view" class="content-section">
                    <h2 class="content-title">App Navigation Management</h2>
                    <div class="form-container" style="background:var(--card-bg); padding:1.5rem; border-radius:8px; box-shadow:var(--shadow); margin-bottom:1.5rem;">
                        <form id="add-nav-item-form">
                            <input type="hidden" id="edit-nav-item-id">
                            <div class="form-group">
                                <label for="nav-item-label">Label (Text):</label>
                                <input type="text" id="nav-item-label" placeholder="e.g., Home" required>
                            </div>
                            <div class="form-group">
                                <label for="nav-item-icon">Font Awesome Icon Class:</label>
                                <input type="text" id="nav-item-icon" placeholder="e.g., fas fa-home" required>
                            </div>
                            <div class="form-group">
                                <label for="nav-item-target">Target Page/Action:</label>
                                <input type="text" id="nav-item-target" placeholder="e.g., index.html or prayerTimesView" required>
                                <small>For internal PWA views, use a unique ID. For external links, use full URL.</small>
                            </div>
                             <div class="form-group">
                                <label for="nav-item-order">Order:</label>
                                <input type="number" id="nav-item-order" placeholder="e.g., 1" value="1" min="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add/Update Nav Item</button>
                            <button type="button" class="btn btn-secondary" id="cancel-edit-nav-btn" style="display:none;">Cancel Edit</button>
                        </form>
                    </div>
                    <div class="table-container">
                        <h3>Current Navigation Items (Drag to reorder - coming soon)</h3>
                        <ul id="nav-items-list" style="list-style: none; padding: 0;">
                            <!-- Nav items will be listed here -->
                        </ul>
                    </div>
                </section>

                <!-- Content Management Section (Demo) -->
                <section id="content-management-view" class="content-section">
                    <h2 class="content-title">Content Management (Demo)</h2>
                    <p>This section is for managing app content. (Functionality not implemented)</p>
                </section>

                <!-- Settings Section (Demo) -->
                <section id="settings-view" class="content-section">
                    <h2 class="content-title">Settings (Demo)</h2>
                    <p>This section is for app settings. (Functionality not implemented)</p>
                </section>
            </main>
        </div>
    </div>

    <!-- Modals (User modals same as before) -->
    <!-- ... (Keep User Details, Edit User, Confirm Delete Modals) ... -->
     <div id="user-details-modal" class="modal">
        <div class="modal-content"> <div class="modal-header"> <h3>User Details</h3> <span class="close-modal" onclick="closeModal('user-details-modal')">×</span> </div> <div class="modal-body" id="user-details-body"></div> <div class="modal-footer"> <button class="btn btn-secondary" onclick="closeModal('user-details-modal')">Close</button> </div> </div>
    </div>
    <div id="edit-user-modal" class="modal"> <!-- For more complex user edits -->
         <div class="modal-content"> <div class="modal-header"> <h3>Edit User Details</h3> <span class="close-modal" onclick="closeModal('edit-user-modal')">×</span> </div> <div class="modal-body"> <form id="edit-user-details-form"> <input type="hidden" id="edit-user-details-uid"> <div class="form-group"><label for="edit-user-details-name">Display Name:</label><input type="text" id="edit-user-details-name"></div> <div class="form-group"><label for="edit-user-details-role">Role (Stored in DB):</label><input type="text" id="edit-user-details-role" placeholder="e.g., user, editor"></div> </form> </div> <div class="modal-footer"> <button class="btn btn-secondary" onclick="closeModal('edit-user-modal')">Cancel</button> <button class="btn btn-primary" onclick="saveUserDetailsChanges()">Save Changes</button> </div> </div>
    </div>
     <div id="confirm-delete-modal" class="modal"> <div class="modal-content"> <div class="modal-header"> <h3>Confirm Deletion</h3> <span class="close-modal" onclick="closeModal('confirm-delete-modal')">×</span> </div> <div class="modal-body"> <p>Are you sure you want to delete user <strong id="delete-user-name-confirm"></strong> (UID: <strong id="delete-user-id-confirm"></strong>)?</p> <p style="color: var(--danger-color);">This action will delete the user from Firebase Authentication.</p> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" onclick="closeModal('confirm-delete-modal')">Cancel</button> <button type="button" class="btn btn-danger" id="confirm-delete-button">Yes, Delete User</button> </div> </div> </div>


    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase project configuration!
        const firebaseConfig = {
            apiKey: "AIzaSyAY3hXmpCXJUVrBtOaosPY_tsse3sx-O5o", // From your JSON
            authDomain: "nima-d4d7d.firebaseapp.com",          // Constructed: project_id.firebaseapp.com
            databaseURL: "https://nima-d4d7d-default-rtdb.asia-southeast1.firebasedatabase.app", // From your JSON
            projectId: "nima-d4d7d",                           // From your JSON
            storageBucket: "nima-d4d7d.appspot.com",         // Standard format
            messagingSenderId: "919311840182",              // From project_info.project_number - VERIFY
            appId: "GET_YOUR_WEB_APP_ID_FROM_FIREBASE_CONSOLE_FOR_NIMA_PROJECT", // ****** GET THIS FROM FIREBASE CONSOLE ******
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Firebase Auth service
        const db = firebase.database(); // Firebase Realtime Database service

        // --- Hardcoded Access Key & Session ---
        const ACCESS_KEY = "rajax2570"; 
        const SESSION_STORAGE_KEY = "adminPanelAccessGranted_nima";
        const loader = document.getElementById('loader');

        function showLoader(show) { loader.style.display = show ? 'flex' : 'none'; }


        // --- DOM Elements --- (mostly same as before)
        const adminKeyAccessScreen = document.getElementById('admin-key-access-screen');
        const adminPanelScreen = document.getElementById('admin-panel-screen');
        const adminKeyForm = document.getElementById('admin-key-form');
        const keyErrorMessage = document.getElementById('key-error-message');
        const currentSectionTitle = document.getElementById('current-section-title');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const adminNameDisplay = document.getElementById('admin-name-display');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        const addNavItemForm = document.getElementById('add-nav-item-form');
        const navItemsListUl = document.getElementById('nav-items-list');
        const cancelEditNavBtn = document.getElementById('cancel-edit-nav-btn');
        let editingNavItemId = null;

        // --- Key Access & Panel Display Logic (same as before) ---
        adminKeyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            showLoader(true);
            const enteredKey = document.getElementById('admin-access-key').value;
            if (enteredKey === ACCESS_KEY) {
                sessionStorage.setItem(SESSION_STORAGE_KEY, 'true');
                showAdminPanel();
            } else {
                keyErrorMessage.style.display = 'block';
                sessionStorage.removeItem(SESSION_STORAGE_KEY);
                showLoader(false);
            }
        });

        function showAdminPanel() {
            adminKeyAccessScreen.style.display = 'none';
            adminPanelScreen.style.display = 'flex';
            keyErrorMessage.style.display = 'none';
            adminNameDisplay.textContent = "Test Admin";
            loadDashboardData(); 
            fetchUsersFromCollection(); // Changed from loadUsers to reflect Firebase fetching
            loadNavItems();
            showLoader(false);
        }

        adminLogoutBtn.addEventListener('click', (e) => { /* ... same ... */ 
            e.preventDefault();
            sessionStorage.removeItem(SESSION_STORAGE_KEY); 
            adminPanelScreen.style.display = 'none';
            adminKeyAccessScreen.style.display = 'flex';
            document.getElementById('admin-access-key').value = ''; 
        });
        
        window.addEventListener('load', () => {
            showLoader(true);
            if (sessionStorage.getItem(SESSION_STORAGE_KEY) === 'true') {
                showAdminPanel();
            } else {
                adminKeyAccessScreen.style.display = 'flex';
                adminPanelScreen.style.display = 'none';
                showLoader(false);
            }
        });

        // --- Navigation Logic (same as before) ---
        navLinks.forEach(link => { /* ... same ... */ 
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navLinks.forEach(nav => nav.classList.remove('active'));
                link.classList.add('active');
                const targetId = link.getAttribute('data-target');
                contentSections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === targetId) {
                        section.classList.add('active');
                        currentSectionTitle.textContent = link.textContent.trim();
                    }
                });
                if (targetId === 'user-management-view') fetchUsersFromCollection();
                if (targetId === 'nav-management-view') loadNavItems();
            });
        });
        // --- Modal Handling (same as before) ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.onclick = function(event) { /* ... same ... */ 
             document.querySelectorAll('.modal').forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            });
        };

        // --- Dashboard Data ---
        async function loadDashboardData() {
            showLoader(true);
            try {
                // Fetch users from your 'users' collection in RTDB
                const usersSnapshot = await db.ref('users').once('value');
                const usersData = usersSnapshot.val();
                const userCount = usersData ? Object.keys(usersData).length : 0;
                document.getElementById('total-users-count').textContent = userCount;

                const navSnapshot = await db.ref('appNavigation').once('value');
                const navData = navSnapshot.val();
                const navCount = navData ? Object.keys(navData).length : 0;
                document.getElementById('total-nav-links-count').textContent = navCount;


                // Dummy data for other cards
                document.getElementById('total-posts-count').textContent = '0'; // Update if you track this
            } catch (error) {
                console.error("Error loading dashboard data:", error);
                document.getElementById('total-users-count').textContent = 'N/A';
            } finally {
                showLoader(false);
            }
        }

        // --- User Management with Firebase ---
        // **IMPORTANT**: Listing all users directly from Firebase Auth (auth.listUsers()) is an Admin SDK feature,
        // not available on the client-side for security reasons.
        // We will fetch users from a 'users' collection in Realtime Database if you store them there
        // after they sign up/log in on the main app.

        async function fetchUsersFromCollection() {
            showLoader(true);
            const usersTableBody = document.getElementById('users-table').getElementsByTagName('tbody')[0];
            usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Loading users...</td></tr>';
            
            try {
                const snapshot = await db.ref('users').once('value'); // Assuming you have a 'users' node
                const usersData = snapshot.val();
                currentUsers = []; // Reset local cache
                if (usersData) {
                    for (const uid in usersData) {
                        currentUsers.push({ uid, ...usersData[uid] });
                    }
                }
                renderUsersTable();
            } catch (error) {
                console.error("Error fetching users from DB:", error);
                usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger-color);">Error loading users: ${error.message}</td></tr>`;
            } finally {
                showLoader(false);
            }
        }
        
        let currentUsers = []; // To hold users fetched from Firebase

        function renderUsersTable() {
            const usersTableBody = document.getElementById('users-table').getElementsByTagName('tbody')[0];
            usersTableBody.innerHTML = ''; 
            
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            const filteredUsers = currentUsers.filter(user => 
                (user.displayName && user.displayName.toLowerCase().includes(searchTerm)) || 
                (user.email && user.email.toLowerCase().includes(searchTerm))
            );

            if (filteredUsers.length === 0) {
                 usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px;">No users found or match search.</td></tr>';
                 return;
            }

            filteredUsers.forEach(user => {
                const row = usersTableBody.insertRow();
                const creationTime = user.metadata?.creationTime ? new Date(user.metadata.creationTime).toLocaleDateString() : (user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A');
                const userStatus = user.disabled ? 'Banned' : 'Active'; // Assuming 'disabled' means banned

                row.innerHTML = `
                    <td>${user.uid}</td>
                    <td>${user.displayName || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.providerData?.[0]?.providerId || user.provider || 'Email'}</td>
                    <td><span class="status-${userStatus.toLowerCase()}">${userStatus}</span></td>
                    <td>${creationTime}</td>
                    <td class="actions">
                        <a href="#" title="Edit User Details" onclick="openEditUserDetailsModal('${user.uid}')"><i class="fas fa-edit"></i></a>
                        ${!user.disabled ? 
                            `<button title="Disable User (Ban)" onclick="toggleUserDisabled('${user.uid}', true)"><i class="fas fa-user-slash"></i></button>` :
                            `<button title="Enable User (Unban)" onclick="toggleUserDisabled('${user.uid}', false)"><i class="fas fa-user-check"></i></button>`
                        }
                        <button title="Delete User from Auth" onclick="confirmDeleteAuthUser('${user.uid}', '${user.displayName || user.email}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
            });
        }
        document.getElementById('user-search-input').addEventListener('input', renderUsersTable);


        function openEditUserDetailsModal(uid) {
            const user = currentUsers.find(u => u.uid === uid);
            if (!user) { alert('User not found!'); return; }
            document.getElementById('edit-user-details-uid').value = uid;
            document.getElementById('edit-user-details-name').value = user.displayName || '';
            document.getElementById('edit-user-details-role').value = user.role || 'user'; // Assuming 'role' is stored in your DB 'users' collection
            openModal('edit-user-modal');
        }

        async function saveUserDetailsChanges() {
            showLoader(true);
            const uid = document.getElementById('edit-user-details-uid').value;
            const newName = document.getElementById('edit-user-details-name').value;
            const newRole = document.getElementById('edit-user-details-role').value;

            try {
                // Update in Realtime Database 'users' collection
                await db.ref(`users/${uid}`).update({
                    displayName: newName,
                    role: newRole 
                });
                // Note: Updating Firebase Auth displayName requires Admin SDK or for user to be logged in.
                // For this admin panel, we primarily update the DB record.
                alert('User details updated in database successfully!');
                fetchUsersFromCollection(); // Refresh list
                closeModal('edit-user-modal');
            } catch (error) {
                console.error("Error saving user details:", error);
                alert(`Failed to update user details: ${error.message}`);
            } finally {
                showLoader(false);
            }
        }


        async function toggleUserDisabled(uid, shouldDisable) {
            // IMPORTANT: Disabling/Enabling a user in Firebase Auth REQUIRES Admin SDK.
            // This function will SIMULATE the UI change and update a 'disabled' flag in your RTDB 'users' collection.
            // For actual disabling in Auth, you'd call a Cloud Function.
            showLoader(true);
            try {
                await db.ref(`users/${uid}`).update({ disabled: shouldDisable });
                alert(`User ${shouldDisable ? 'disabled' : 'enabled'} in database (Simulating Auth change). Call Admin SDK for actual Auth disable/enable.`);
                fetchUsersFromCollection(); // Refresh list
            } catch (error) {
                console.error("Error updating user disabled status in DB:", error);
                alert(`Failed: ${error.message}`);
            } finally {
                showLoader(false);
            }
        }

        let authUserIdToDelete = null;
        let authUserNameToDelete = null;
        function confirmDeleteAuthUser(uid, name) {
            // IMPORTANT: Deleting a user from Firebase Auth REQUIRES Admin SDK.
            // This will SIMULATE UI change and delete from RTDB 'users' collection.
            authUserIdToDelete = uid;
            authUserNameToDelete = name;
            document.getElementById('delete-user-name-confirm').textContent = name;
            document.getElementById('delete-user-id-confirm').textContent = uid;
            openModal('confirm-delete-modal');
        }

        document.getElementById('confirm-delete-button').addEventListener('click', async () => {
            if (authUserIdToDelete) {
                showLoader(true);
                try {
                    // Delete from 'users' collection in RTDB
                    await db.ref(`users/${authUserIdToDelete}`).remove();
                    alert(`User ${authUserNameToDelete} (UID: ${authUserIdToDelete}) removed from database. For Auth deletion, call Admin SDK.`);
                    fetchUsersFromCollection(); // Refresh user list
                    loadDashboardData(); // Update dashboard counts
                    closeModal('confirm-delete-modal');
                } catch (error) {
                    console.error("Error deleting user from DB:", error);
                    alert(`Failed to delete user from DB: ${error.message}`);
                } finally {
                    authUserIdToDelete = null;
                    authUserNameToDelete = null;
                    showLoader(false);
                }
            }
        });


        // --- Navigation Management with Firebase Realtime Database ---
        addNavItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader(true);
            const label = document.getElementById('nav-item-label').value;
            const icon = document.getElementById('nav-item-icon').value;
            const target = document.getElementById('nav-item-target').value;
            const order = parseInt(document.getElementById('nav-item-order').value);

            const navItemData = { label, icon, target, order, createdAt: firebase.database.ServerValue.TIMESTAMP };

            try {
                if (editingNavItemId) {
                    await db.ref('appNavigation/' + editingNavItemId).update(navItemData);
                    alert('Navigation item updated!');
                } else {
                    await db.ref('appNavigation').push(navItemData);
                    alert('Navigation item added!');
                }
                addNavItemForm.reset();
                document.getElementById('edit-nav-item-id').value = '';
                editingNavItemId = null;
                cancelEditNavBtn.style.display = 'none';
                loadNavItems();
                loadDashboardData(); // Update dashboard
            } catch (error) {
                console.error("Error saving nav item: ", error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoader(false);
            }
        });
        
        cancelEditNavBtn.addEventListener('click', () => {
            addNavItemForm.reset();
            document.getElementById('edit-nav-item-id').value = '';
            editingNavItemId = null;
            cancelEditNavBtn.style.display = 'none';
        });

        async function loadNavItems() {
            showLoader(true);
            navItemsListUl.innerHTML = '<li>Loading navigation items...</li>';
            try {
                const snapshot = await db.ref('appNavigation').orderByChild('order').once('value');
                navItemsListUl.innerHTML = ''; // Clear
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const item = childSnapshot.val();
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span><i class="${item.icon}"></i> ${item.label} (Order: ${item.order}, Target: ${item.target})</span>
                            <span class="actions">
                                <button class="btn btn-secondary btn-sm" onclick="editNavItem('${key}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm" onclick="deleteNavItem('${key}')"><i class="fas fa-trash"></i></button>
                            </span>
                        `;
                        navItemsListUl.appendChild(li);
                    });
                } else {
                    navItemsListUl.innerHTML = '<li>No navigation items found. Add some above.</li>';
                }
            } catch (error) {
                console.error("Error loading nav items:", error);
                navItemsListUl.innerHTML = `<li>Error: ${error.message}</li>`;
            } finally {
                showLoader(false);
            }
        }

        function editNavItem(key) {
            showLoader(true);
            db.ref('appNavigation/' + key).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const item = snapshot.val();
                    document.getElementById('edit-nav-item-id').value = key;
                    document.getElementById('nav-item-label').value = item.label;
                    document.getElementById('nav-item-icon').value = item.icon;
                    document.getElementById('nav-item-target').value = item.target;
                    document.getElementById('nav-item-order').value = item.order;
                    editingNavItemId = key;
                    cancelEditNavBtn.style.display = 'inline-block';
                    document.getElementById('nav-item-label').focus();
                } else {
                    alert('Item not found for editing.');
                }
            }).catch(error => alert(`Error fetching item: ${error.message}`))
            .finally(() => showLoader(false));
        }

        async function deleteNavItem(key) {
            if (confirm('Are you sure you want to delete this navigation item?')) {
                showLoader(true);
                try {
                    await db.ref('appNavigation/' + key).remove();
                    alert('Navigation item deleted!');
                    loadNavItems();
                    loadDashboardData(); // Update dashboard
                } catch (error) {
                    console.error("Error deleting nav item:", error);
                    alert(`Error: ${error.message}`);
                } finally {
                    showLoader(false);
                }
            }
        }

    </script>
</body>
</html>